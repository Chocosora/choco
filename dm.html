<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>더모아 엔화 계산기</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333333;
        }

        .input-group {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555555;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #cccccc;
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .calculated-text {
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #333333;
        }

        button {
            padding: 10px 20px;
            font-size: 14px;
            background-color: #333333;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            margin-top: 10px;
        }

        button.remove {
            background-color: #e74c3c;
        }

        @media (max-width: 500px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 22px;
            }

            .container {
                padding: 15px;
            }

            button {
                font-size: 12px;
                padding: 8px 16px;
            }

            input[type="number"] {
                font-size: 14px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>더모아 엔화 계산기</h1>
        <div class="input-group">
            <label for="yen">오늘의 엔화</label>
            <input type="number" id="yen" placeholder="엔화 입력" oninput="updateAndSave()">
        </div>
        <div class="input-group">
            <label for="won">오늘의 원화</label>
            <input type="number" id="won" placeholder="원화 입력" oninput="updateAndSave()">
        </div>
        <div id="yenContainer">
            <!-- 기본 1개의 쇼핑금액 입력 칸 -->
            <div class="input-group yen-group">
                <label for="inputYen1">쇼핑금액</label>
                <input type="number" id="inputYen1" class="inputYen" placeholder="쇼핑금액 입력" oninput="updateAllCalculations()">
            </div>
            <div class="input-group yen-group">
                <input type="number" id="inputYen2" class="inputYen" placeholder="쇼핑금액 입력" oninput="updateAllCalculations()">
            </div>
            <div class="input-group yen-group">
                <input type="number" id="inputYen3" class="inputYen" placeholder="쇼핑금액 입력" oninput="updateAllCalculations()">
            </div>
        </div>
        <button onclick="addYenGroup()">쇼핑금액 추가</button>
        <button class="remove" onclick="removeLastYenGroup()">쇼핑금액 삭제</button>
        <div class="calculated-text" id="shortageText">부족한 금액: 0000엔</div>
        <div class="calculated-text" id="totalWonText">합계: 0000원</div>
    </div>

    <!-- Firebase SDK 및 Firestore 연결 -->
    <script type="module">
      // Firebase 초기화
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
      import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyC4FWP-jskItmNA4SVP-kDGA1gL_U85asw",
        authDomain: "chocosora-ad4df.firebaseapp.com",
        databaseURL: "https://chocosora-ad4df-default-rtdb.firebaseio.com",
        projectId: "chocosora-ad4df",
        storageBucket: "chocosora-ad4df.appspot.com",
        messagingSenderId: "798065461606",
        appId: "1:798065461606:web:fcc2308eae7a71e8f360a7",
        measurementId: "G-4FYC7HVNNV"
      };

      // Firebase 및 Firestore 초기화
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Firestore에서 데이터 불러오기
      window.onload = async function() {
        const docRef = doc(db, "exchangeRates", "today");
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('yen').value = data.todayYen || '';
          document.getElementById('won').value = data.todayWon || '';
          updateAllCalculations(); // 불러온 값으로 계산 업데이트
        } else {
          console.log("No such document!");
        }
      };

      // Firestore에 데이터 저장
      async function updateAndSave() {
        const yenValue = parseFloat(document.getElementById('yen').value);
        const wonValue = parseFloat(document.getElementById('won').value);

        // Firestore에 데이터 저장
        await setDoc(doc(db, "exchangeRates", "today"), {
          todayYen: yenValue,
          todayWon: wonValue
        });

        updateAllCalculations(); // 변경된 값으로 계산 업데이트
      }

      function updateAllCalculations() {
        const yen = parseFloat(document.getElementById('yen').value) || 0;
        const won = parseFloat(document.getElementById('won').value) || 0;
        let totalYen = 0;

        // 모든 쇼핑금액 입력값을 합산
        const yenGroups = document.querySelectorAll('.inputYen');
        yenGroups.forEach(group => {
            totalYen += parseFloat(group.value) || 0;
        });

        // 첫 번째 입력한 엔화보다 부족한 금액 계산
        const shortage = yen - totalYen;
        document.getElementById('shortageText').innerText = `부족한 금액: ${shortage >= 0 ? shortage : 0}엔`;

        // 쇼핑금액 합계를 원화로 변환하여 표시
        if (!isNaN(yen) && !isNaN(won) && yen > 0) {
            const exchangeRate = won / yen;
            const totalWon = (totalYen * exchangeRate).toFixed(0);
            document.getElementById('totalWonText').innerText = `합계: ${totalWon}원`;
        } else {
            document.getElementById('totalWonText').innerText = '합계: 0000원';
        }
      }

      function addYenGroup() {
        const yenContainer = document.getElementById('yenContainer');
        const newGroup = document.createElement('div');
        newGroup.classList.add('input-group', 'yen-group');
        newGroup.innerHTML = `
            <input type="number" class="inputYen" placeholder="쇼핑금액 입력" oninput="updateAllCalculations()">
        `;
        yenContainer.appendChild(newGroup);
      }

      function removeLastYenGroup() {
        const yenContainer = document.getElementById('yenContainer');
        if (yenContainer.children.length > 0) {
            yenContainer.removeChild(yenContainer.lastChild);
            updateAllCalculations(); // 삭제 후 계산 업데이트
        }
      }
    </script>
</body>
</html>
