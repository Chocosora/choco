<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <!-- 뷰포트 메타 태그 수정: 사용자가 페이지를 확대/축소하지 못하도록 설정 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>더모아 엔화 계산기</title>
    <!-- Font Awesome CDN for camera icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 15px; /* 패딩을 줄여 전체 간격 축소 */
            background-color: #f5f5f5;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 15px; /* 패딩을 줄여 전체 간격 축소 */
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 12px; /* 간격 축소 */
            color: #333333;
            font-size: 24px;
        }

        .input-group {
            margin-bottom: 8px; /* 간격 축소 */
            display: flex;
            align-items: center;
        }

        label {
            display: block;
            margin-bottom: 3px; /* 간격 축소 */
            color: #555555;
            font-size: 14px;
        }

        .input-group input[type="number"] {
            flex: 1;
            padding: 6px; /* 패딩 축소 */
            font-size: 16px; /* 모바일에서 자동 확대 방지를 위해 폰트 크기 유지 */
            border: 1px solid #cccccc;
            border-radius: 4px;
            box-sizing: border-box;
            margin-right: 5px; /* 입력 필드와 버튼 간 간격 */
        }

        .input-group button.camera-button {
            background-color: #007bff;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            padding: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-group button.camera-button:hover {
            background-color: #0056b3;
        }

        .calculated-text {
            margin-top: 6px; /* 간격 축소 */
            font-size: 14px; /* 폰트 크기 축소 */
            font-weight: bold;
            color: #333333;
        }

        .shortage {
            color: #2ecc71; /* 초록색 */
        }

        .excess {
            color: #e74c3c; /* 빨간색 */
        }

        button {
            padding: 6px 12px; /* 패딩 축소 */
            font-size: 14px;
            background-color: #333333;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            margin-top: 6px; /* 간격 축소 */
            margin-right: 5px; /* 버튼 간 간격 추가 */
        }

        button.remove {
            background-color: #e74c3c;
        }

        .spacer {
            margin-bottom: 15px; /* 줄 간격을 확보하는 여백 조정 */
        }

        @media (max-width: 500px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 20px;
            }

            .container {
                padding: 10px;
            }

            button {
                font-size: 12px;
                padding: 5px 10px;
            }

            .input-group input[type="number"] {
                font-size: 16px; /* 모바일에서 자동 확대 방지를 위해 폰트 크기 유지 */
                padding: 5px;
            }

            .input-group button.camera-button {
                font-size: 14px;
                padding: 5px;
            }
        }

        /* 추가: 이미지 미리보기 */
        #preview {
            display: none;
            margin-top: 10px;
            max-width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* 로딩 스피너 스타일 */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #333333;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>더모아 엔화 계산기</h1>
        <div class="input-group">
            <label for="yen">오늘의 엔화</label>
            <input type="number" id="yen" placeholder="엔화 입력" min="0">
        </div>
        <div class="input-group">
            <label for="won">오늘의 원화</label>
            <input type="number" id="won" placeholder="원화 입력" min="0">
        </div>
        <button id="saveButton">환율 저장</button> <!-- 저장 버튼 -->
        <div id="saveMessage" class="calculated-text"></div> <!-- 저장 메시지 표시를 위한 공간 추가 -->

        <div class="spacer"></div> <!-- 줄 간격을 확보하는 공간 -->

        <!-- 쇼핑금액 입력 필드들을 한 번에 표시하기 위해 상위 레이블 제거 -->
        <div id="yenContainer">
            <!-- 기본 3개의 쇼핑금액 입력 칸 -->
            <div class="input-group yen-group">
                <input type="number" class="inputYen" placeholder="쇼핑금액 입력" min="0">
                <button class="camera-button" title="사진으로 입력"><i class="fas fa-camera"></i></button>
            </div>
            <div class="input-group yen-group">
                <input type="number" class="inputYen" placeholder="쇼핑금액 입력" min="0">
                <button class="camera-button" title="사진으로 입력"><i class="fas fa-camera"></i></button>
            </div>
            <div class="input-group yen-group">
                <input type="number" class="inputYen" placeholder="쇼핑금액 입력" min="0">
                <button class="camera-button" title="사진으로 입력"><i class="fas fa-camera"></i></button>
            </div>
        </div>
        <button id="addRowButton">줄 추가</button> <!-- 쇼핑금액 추가 버튼 -->
        <button id="removeRowButton" class="remove">줄 삭제</button> <!-- 쇼핑금액 삭제 버튼 -->
        <!-- 사진으로 입력 버튼 제거 -->
        <img id="preview" src="#" alt="Captured Image Preview">

        <div class="calculated-text" id="shortageText">부족한 금액: 0엔</div>
        <div class="calculated-text" id="totalWonText">합계: 0원</div>
    </div>

    <!-- Tesseract.js 라이브러리 포함 -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <!-- Firebase SDK 및 Firestore 연결 -->
    <script type="module">
      // Firebase 초기화
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
      import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyC4FWP-jskItmNA4SVP-kDGA1gL_U85asw",
        authDomain: "chocosora-ad4df.firebaseapp.com",
        databaseURL: "https://chocosora-ad4df-default-rtdb.firebaseio.com",
        projectId: "chocosora-ad4df",
        storageBucket: "chocosora-ad4df.appspot.com",
        messagingSenderId: "798065461606",
        appId: "1:798065461606:web:fcc2308eae7a71e8f360a7",
        measurementId: "G-4FYC7HVNNV"
      };

      // Firebase 및 Firestore 초기화
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Firestore에서 데이터 불러오기 및 이벤트 리스너 설정
      window.addEventListener('DOMContentLoaded', async function() {
        // Firestore에서 환율 데이터 불러오기
        const docRef = doc(db, "exchangeRates", "today");
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('yen').value = data.todayYen || '';
          document.getElementById('won').value = data.todayWon || '';
        } else {
          console.log("No such document!");
        }

        // 초기 계산
        updateAllCalculations();

        // 초기 쇼핑금액 입력 필드에 이벤트 리스너 추가
        const initialInputs = document.querySelectorAll('.inputYen');
        initialInputs.forEach(input => {
            input.addEventListener('input', updateAllCalculations);
        });

        // 오늘의 엔화와 원화 입력 필드에 이벤트 리스너 추가
        document.getElementById('yen').addEventListener('input', updateAllCalculations);
        document.getElementById('won').addEventListener('input', updateAllCalculations);

        // 초기 카메라 버튼 이벤트 리스너 추가
        const initialCameraButtons = document.querySelectorAll('.camera-button');
        initialCameraButtons.forEach(button => {
            button.addEventListener('click', handleCameraButtonClick);
        });
      });

      // Firestore에 데이터 저장 (저장 버튼을 눌렀을 때만 실행)
      document.getElementById("saveButton").addEventListener("click", async function() {
        const yenValue = parseFloat(document.getElementById('yen').value);
        const wonValue = parseFloat(document.getElementById('won').value);
        const saveMessage = document.getElementById("saveMessage");

        if (!isNaN(yenValue) && !isNaN(wonValue)) {
          try {
            // Firestore에 데이터 저장
            await setDoc(doc(db, "exchangeRates", "today"), {
              todayYen: yenValue,
              todayWon: wonValue
            });
            console.log("Firestore에 데이터가 저장되었습니다.");
            saveMessage.innerText = "서버에 환율이 전송되었습니다."; // 메시지 출력
          } catch (error) {
            console.error("Firestore 저장 중 오류 발생: ", error);
            saveMessage.innerText = "서버에 저장하는 중 오류가 발생했습니다.";
          }
        } else {
          console.log("숫자가 올바르지 않습니다.");
          saveMessage.innerText = "유효한 숫자를 입력하세요."; // 유효하지 않은 숫자 입력 시 메시지 출력
        }
      });

      // 줄 추가
      document.getElementById("addRowButton").addEventListener("click", function() {
        const yenContainer = document.getElementById('yenContainer');
        const newGroup = document.createElement('div');
        newGroup.classList.add('input-group', 'yen-group');
        newGroup.innerHTML = `
            <input type="number" class="inputYen" placeholder="쇼핑금액 입력" min="0">
            <button class="camera-button" title="사진으로 입력"><i class="fas fa-camera"></i></button>
        `;
        yenContainer.appendChild(newGroup);

        // 새로 추가된 입력 필드에 이벤트 리스너 추가
        const newInput = newGroup.querySelector('.inputYen');
        newInput.addEventListener('input', updateAllCalculations);

        // 새로 추가된 카메라 버튼에 이벤트 리스너 추가
        const newCameraButton = newGroup.querySelector('.camera-button');
        newCameraButton.addEventListener('click', handleCameraButtonClick);
      });

      // 줄 삭제
      document.getElementById("removeRowButton").addEventListener("click", function() {
        const yenContainer = document.getElementById('yenContainer');
        if (yenContainer.children.length > 1) { // 최소 1개의 쇼핑금액 칸은 남겨둠
          yenContainer.removeChild(yenContainer.lastChild);
          updateAllCalculations(); // 삭제 후 계산 업데이트
        }
      });

      // 각 카메라 버튼 클릭 시 처리
      function handleCameraButtonClick(event) {
        const cameraButton = event.currentTarget;
        const inputGroup = cameraButton.parentElement;
        const inputField = inputGroup.querySelector('.inputYen');

        // 파일 입력 트리거
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.capture = 'environment';
        fileInput.style.display = 'none';

        fileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(evt) {
              const imageSrc = evt.target.result;
              // 이미지 처리 및 OCR 수행
              processImage(imageSrc, inputField);
            };
            reader.readAsDataURL(file);
          }
        });

        // 트리거 클릭
        fileInput.click();
      }

      // 이미지 처리 및 OCR 수행
      function processImage(imageSrc, inputField) {
        console.log("이미지 처리 시작");
        // 로딩 스피너 추가
        const spinner = document.createElement('div');
        spinner.classList.add('spinner');
        inputField.parentElement.appendChild(spinner);

        Tesseract.recognize(
          imageSrc,
          'eng+kor', // 언어 설정 (영어와 한국어)
          {
            logger: m => console.log(m)
          }
        ).then(({ data: { text } }) => {
          console.log("인식된 텍스트:", text);
          extractNumbers(text, inputField);
        })
        .catch(err => {
          console.error(err);
          alert('텍스트 인식 중 오류가 발생했습니다.');
        })
        .finally(() => {
          // 로딩 스피너 제거
          spinner.remove();
        });
      }

      // 인식된 텍스트에서 숫자 추출 및 쇼핑금액 필드에 입력
      function extractNumbers(text, inputField) {
        // 정규식을 사용하여 숫자 추출
        const numbers = text.match(/\d{1,3}(?:,\d{3})*(?:\.\d+)?/g);
        if (numbers) {
          console.log("추출된 숫자:", numbers);
          // 첫 번째 숫자를 선택하여 입력 필드에 채움
          const firstNumber = numbers[0];
          const cleanNum = parseFloat(firstNumber.replace(/,/g, ''));
          if (!isNaN(cleanNum)) {
            inputField.value = cleanNum;
            updateAllCalculations();
          } else {
            alert('인식된 숫자가 유효하지 않습니다.');
          }
        } else {
          alert('이미지에서 숫자를 인식할 수 없습니다.');
        }
      }

      // 계산 함수 정의
      function updateAllCalculations() {
        const yenInput = document.getElementById('yen');
        const wonInput = document.getElementById('won');
        const yen = parseFloat(yenInput.value) || 0;
        const won = parseFloat(wonInput.value) || 0;
        let totalYen = 0;

        // 모든 쇼핑금액 입력값을 합산
        const yenGroups = document.querySelectorAll('.inputYen');
        yenGroups.forEach(group => {
            totalYen += parseFloat(group.value) || 0;
        });

        // 부족 또는 초과한 금액 계산 (오늘의 엔화에서 쇼핑금액 합을 뺀 값)
        const difference = yen - totalYen;
        const shortageElement = document.getElementById('shortageText');

        if (difference > 0) {
            // 부족한 금액
            shortageElement.innerText = `부족한 금액: ${difference}엔`;
            shortageElement.classList.add('shortage');
            shortageElement.classList.remove('excess');
        } else if (difference < 0) {
            // 초과한 금액
            shortageElement.innerText = `초과한 금액: ${Math.abs(difference)}엔`;
            shortageElement.classList.add('excess');
            shortageElement.classList.remove('shortage');
        } else {
            // 정확히 맞을 때
            shortageElement.innerText = `부족한 금액: 0엔`;
            shortageElement.classList.add('shortage');
            shortageElement.classList.remove('excess');
        }

        // 쇼핑금액 합계를 원화로 변환하여 표시
        const totalWonElement = document.getElementById('totalWonText');
        if (!isNaN(yen) && !isNaN(won) && yen > 0) {
            const exchangeRate = won / yen;
            const totalWon = (totalYen * exchangeRate).toFixed(0);
            totalWonElement.innerText = `합계: ${totalWon}원`;
        } else {
            totalWonElement.innerText = '합계: 0원';
        }
      }
    </script>
</body>
</html>
